<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <nav class="navbar">
        <a href="/" class="nav-brand"> è§†é¢‘å¹³å°</a>
        <div class="nav-user">
            <span id="username"></span>
            <a href="/upload">ä¸Šä¼ </a>
            <a href="#" onclick="logout()">é€€å‡º</a>
        </div>
    </nav>

    <main class="container">
        <div class="files-header">
            <h2>æˆ‘çš„æ–‡ä»¶</h2>
            <a href="/upload" class="btn btn-primary">+ ä¸Šä¼ æ–°æ–‡ä»¶</a>
        </div>

        <div id="loading" class="loading">åŠ è½½ä¸­...</div>
        <div id="emptyState" class="empty-state" style="display:none;">
            <p> æš‚æ— æ–‡ä»¶</p>
            <a href="/upload" class="btn btn-primary">ä¸Šä¼ ç¬¬ä¸€ä¸ªè§†é¢‘</a>
        </div>

        <div id="filesList" class="files-grid"></div>
    </main>

    <script src="/static/js/common.js"></script>
    <script>
        requireAuth();

        async function loadFiles() {
            try {
                const resp = await authFetch('/api/v1/files');
                const data = await resp.json();

                document.getElementById('loading').style.display = 'none';

                if (!data.files || data.files.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                const container = document.getElementById('filesList');
                container.innerHTML = data.files.map(f => `
                    <div class="file-card">
                        <div class="file-icon">${getFileIcon(f.file_name)}</div>
                        <div class="file-info">
                            <h4 class="file-name" title="${f.file_name}">${f.file_name}</h4>
                            <p class="file-meta">
                                ${formatSize(f.file_size)} Â· ${getStatusText(f.status)}
                            </p>
                            <p class="file-hash" title="${f.file_hash}">${f.file_hash.substring(0, 16)}...</p>
                        </div>
                        <div class="file-actions">
                            ${f.status === 1 ? `
                                <a href="/play/${f.file_hash}" class="btn btn-sm">â–¶ æ’­æ”¾</a>
                                <a href="#" onclick="downloadFile('${f.file_hash}', '${f.file_name}')" class="btn btn-sm btn-secondary">ä¸‹è½½</a>
                            ` : ''}
                            <button onclick="deleteFile('${f.file_hash}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('loading').innerHTML = 'åŠ è½½å¤±è´¥: ' + err.message;
            }
        }

        function getFileIcon(name) {
            const ext = name.split('.').pop().toLowerCase();
            const icons = { mp4: 'ğŸ¬', mkv: 'ğŸ¬', avi: 'ğŸ¬', mov: 'ğŸ¬', webm: 'ğŸ¬', mp3: 'ğŸµ', wav: 'ğŸµ' };
            return icons[ext] || 'ğŸ“„';
        }

        function getStatusText(status) {
            return { 0: 'ä¸Šä¼ ä¸­', 1: 'å·²å®Œæˆ', 2: 'è½¬ç ä¸­', 3: 'å·²è½¬ç ', '-1': 'å·²å–æ¶ˆ' }[status] || 'æœªçŸ¥';
        }

        async function downloadFile(hash, name) {
            const resp = await authFetch(`/api/v1/files/${hash}/download`);
            if (!resp.ok) {
                alert('ä¸‹è½½å¤±è´¥');
                return;
            }
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function deleteFile(hash) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ–‡ä»¶å—ï¼Ÿ')) return;
            try {
                const resp = await authFetch(`/api/v1/files/${hash}`, { method: 'DELETE' });
                if (resp.ok) {
                    loadFiles();
                } else {
                    const data = await resp.json();
                    alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (err) {
                alert('åˆ é™¤å¤±è´¥: ' + err.message);
            }
        }

        loadFiles();
    </script>
</body>

</html>