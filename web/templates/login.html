<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <nav class="navbar">
        <a href="/" class="nav-brand">ğŸ“¹ è§†é¢‘å¹³å°</a>
    </nav>

    <main class="container">
        <div class="auth-container">
            <div class="auth-tabs">
                <button class="tab-btn active" onclick="showTab('login')">ç™»å½•</button>
                <button class="tab-btn" onclick="showTab('register')">æ³¨å†Œ</button>
            </div>

            <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" required minlength="3">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary btn-block">ç™»å½•</button>
                <p id="loginError" class="error-msg"></p>
            </form>

            <form id="registerForm" class="auth-form" style="display:none;" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="regUsername" required minlength="3">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="regPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤å¯†ç </label>
                    <input type="password" id="regConfirm" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary btn-block">æ³¨å†Œ</button>
                <p id="regError" class="error-msg"></p>
            </form>
        </div>
    </main>

    <script src="/static/js/common.js"></script>
    <script>
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.style.display = 'none');

            if (tab === 'login') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('registerForm').style.display = 'block';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errEl = document.getElementById('loginError');
            errEl.textContent = '';

            try {
                const resp = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'ç™»å½•å¤±è´¥');

                localStorage.setItem('token', data.token);
                localStorage.setItem('username', username);
                window.location.href = '/files';
            } catch (err) {
                errEl.textContent = err.message;
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regConfirm').value;
            const errEl = document.getElementById('regError');
            errEl.textContent = '';

            if (password !== confirm) {
                errEl.textContent = 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´';
                return;
            }

            try {
                const resp = await fetch('/api/v1/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'æ³¨å†Œå¤±è´¥');

                showTab('login');
                document.getElementById('loginUsername').value = username;
                alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
            } catch (err) {
                errEl.textContent = err.message;
            }
        }

        // å·²ç™»å½•åˆ™è·³è½¬
        if (localStorage.getItem('token')) {
            window.location.href = '/files';
        }
    </script>
</body>

</html>