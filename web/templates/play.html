<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
</head>

<body>
    <nav class="navbar">
        <a href="/" class="nav-brand">ğŸ“¹ è§†é¢‘å¹³å°</a>
        <div class="nav-user">
            <span id="username"></span>
            <a href="/files">æˆ‘çš„æ–‡ä»¶</a>
            <a href="#" onclick="logout()">é€€å‡º</a>
        </div>
    </nav>

    <main class="container">
        <div class="player-container">
            <div class="player-wrapper">
                <video id="videoPlayer" controls></video>
            </div>

            <div class="player-info">
                <h2 id="videoTitle">åŠ è½½ä¸­...</h2>
                <p id="videoMeta"></p>
            </div>

            <div id="transcodeStatus" class="transcode-status" style="display:none;">
                <div class="spinner"></div>
                <p>è§†é¢‘æ­£åœ¨è½¬ç ä¸­ï¼Œè¯·ç¨å€™...</p>
                <p class="hint-small">è½¬ç å®Œæˆåå°†è‡ªåŠ¨æ’­æ”¾</p>
            </div>

            <div id="errorState" class="error-state" style="display:none;">
                <p>âš ï¸ è§†é¢‘æš‚æ—¶æ— æ³•æ’­æ”¾</p>
                <p id="errorMsg"></p>
                <a href="/files" class="btn btn-secondary">è¿”å›æ–‡ä»¶åˆ—è¡¨</a>
            </div>
        </div>
    </main>

    <script src="/static/js/common.js"></script>
    <script>
        requireAuth();

        const fileHash = '{{.fileHash}}';
        const video = document.getElementById('videoPlayer');

        async function loadVideo() {
            try {
                // è·å–æ–‡ä»¶ä¿¡æ¯
                const resp = await authFetch(`/api/v1/files/${fileHash}`);
                if (!resp.ok) throw new Error('æ–‡ä»¶ä¸å­˜åœ¨');

                const file = await resp.json();
                document.getElementById('videoTitle').textContent = file.file_name;
                document.getElementById('videoMeta').textContent = `${formatSize(file.file_size)} Â· ${file.created_at}`;

                if (file.status === 2) {
                    // è½¬ç ä¸­
                    document.getElementById('transcodeStatus').style.display = 'block';
                    setTimeout(loadVideo, 5000); // 5ç§’åé‡è¯•
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰ HLS æµ
                const hlsResp = await authFetch(`/api/v1/hls/${fileHash}/master.m3u8`, { method: 'HEAD' });

                if (hlsResp.ok) {
                    // æ’­æ”¾ HLS
                    playHLS(`/api/v1/hls/${fileHash}/master.m3u8`);
                } else {
                    // ç›´æ¥æ’­æ”¾åŸè§†é¢‘
                    playDirect(`/api/v1/files/${fileHash}/download`);
                }
            } catch (err) {
                showError(err.message);
            }
        }

        function playHLS(url) {
            if (Hls.isSupported()) {
                const hls = new Hls({
                    xhrSetup: function (xhr) {
                        xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('token'));
                    }
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error('HLS Error:', data);
                        // é™çº§åˆ°ç›´æ¥æ’­æ”¾
                        playDirect(`/api/v1/files/${fileHash}/download`);
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari åŸç”Ÿæ”¯æŒ
                video.src = url;
                video.addEventListener('loadedmetadata', () => video.play());
            } else {
                playDirect(`/api/v1/files/${fileHash}/download`);
            }
        }

        function playDirect(url) {
            // éœ€è¦å¸¦ token çš„è¯·æ±‚
            authFetch(url).then(resp => {
                if (!resp.ok) throw new Error('æ— æ³•åŠ è½½è§†é¢‘');
                return resp.blob();
            }).then(blob => {
                video.src = URL.createObjectURL(blob);
            }).catch(err => showError(err.message));
        }

        function showError(msg) {
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMsg').textContent = msg;
            document.querySelector('.player-wrapper').style.display = 'none';
        }

        loadVideo();
    </script>
</body>

</html>